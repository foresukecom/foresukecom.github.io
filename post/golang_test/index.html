
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    Golangでテストコードを書く少年のお話 | ふぉれすけ広場
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="http://foresukecom.github.io/post/golang_test/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link href="http://foresukecom.github.ioindex.xml" rel="alternate" type="application/rss+xml" title="ふぉれすけ広場" />
  <link href="http://foresukecom.github.ioindex.xml" rel="feed" type="application/rss+xml" title="ふぉれすけ広場" />

  
  

  
  <link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="images/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
  <link rel="manifest" href="images/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="images/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://foresukecom.github.io">ふぉれすけ広場</a></h1>
        <h2>筋トレしたり、お酒を飲んだり、壁を登ったり。</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/foresukecom" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/foresukecom" target="_blank">GitHub</a></li>
          
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>Golangでテストコードを書く少年のお話</h1>
      <div class="meta">
        Jan 22, 2019 &nbsp;
        
          #<a href="/tags/golang">Golang</a>&nbsp;
        
      </div>
    </div>
    <article>
      <h2 id="はじめに">はじめに</h2>
<p>お仕事でGolangのテストコードを書くことになったのでお勉強しました。<br>
テスト対象は以下のプログラムです。</p>
<script type="application/javascript" src="https://gist.github.com/foresukecom/3a3fb85080fb43500bc83d7b98c41458.js"></script>

<p>毎朝のルーティンを明文化し、以下の処理をしています。</p>
<ul>
<li>降水確率40%以上なら傘を装備する。</li>
<li>冬、もしくは最低気温が5度以下ならコートを装備する。</li>
</ul>
<p>以下の通り、4つの命令と2つの条件分岐で構成されています。</p>
<table>
<thead>
<tr>
<th align="left">項</th>
<th align="left">種別</th>
<th align="left">やってること</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">①</td>
<td align="left">命令</td>
<td align="left">持ち物を入れるカバンを用意</td>
</tr>
<tr>
<td align="left">②</td>
<td align="left">条件分岐</td>
<td align="left">降水確率による判定</td>
</tr>
<tr>
<td align="left">③</td>
<td align="left">命令</td>
<td align="left">カバンに傘を入れる</td>
</tr>
<tr>
<td align="left">④</td>
<td align="left">条件分岐</td>
<td align="left">季節、最低気温による判定</td>
</tr>
<tr>
<td align="left">⑤</td>
<td align="left">命令</td>
<td align="left">カバンにコートを入れる</td>
</tr>
<tr>
<td align="left">⑥</td>
<td align="left">命令</td>
<td align="left">カバンを持ち出す</td>
</tr>
</tbody>
</table>
<h2 id="テストの種類">テストの種類</h2>
<p>カバレッジとはテストの網羅率のことを指しています。<br>
「どのパターンのテストを行えば、必要な範囲のテストが完了したのか?」の指標となります。<br>
「必要な範囲」については、C0カバレッジ、C1カバレッジ、C2カバレッジ…とカバレッジの種類によって異なります。</p>
<p>それぞのカバレッジについて簡単に説明していきます。<br>
※C3以降もありますが、よく使われるのはC2までみたいなので、今回は省略します。</p>
<h3 id="c0カバレッジ命令網羅">C0カバレッジ(命令網羅)</h3>
<p>すべての命令を最低1回は実行する、というテストケースを満たせばカバレッジが100%になります。<br>
以下のパターンを実行すれば、すべての命令を実行することができるので、C0カバレッジ100%になります。<br>
「降水確率が50%、季節は冬、最低気温12度。」</p>
<h3 id="c1カバレッジ分岐網羅">C1カバレッジ(分岐網羅)</h3>
<p>すべて条件分岐の組み合わせを通る、というテストケースを満たせばカバレッジが100%になります。<br>
今回はTrue/Falseの分岐が2つあるので4パターンの組み合わせでテストを行う必要があります。</p>
<table>
<thead>
<tr>
<th align="left">パターン</th>
<th align="center">②</th>
<th align="center">④</th>
<th align="left">具体例</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">パターン1</td>
<td align="center">True</td>
<td align="center">True</td>
<td align="left">降水確率が50%、季節は冬、最低気温12度。</td>
</tr>
<tr>
<td align="left">パターン2</td>
<td align="center">True</td>
<td align="center">False</td>
<td align="left">降水確率が50%、季節は春、最低気温12度。</td>
</tr>
<tr>
<td align="left">パターン3</td>
<td align="center">False</td>
<td align="center">True</td>
<td align="left">降水確率が20%、季節は冬、最低気温12度。</td>
</tr>
<tr>
<td align="left">パターン4</td>
<td align="center">False</td>
<td align="center">False</td>
<td align="left">降水確率が20%、季節は春、最低気温12度。</td>
</tr>
</tbody>
</table>
<p>具体的には以下のパラメータでテストをやればOKです。</p>
<h3 id="c2カバレッジ条件網羅率">C2カバレッジ(条件網羅率)</h3>
<p>すべての条件の組み合わせを通る、というテストケースを満たせばカバレッジが100%になります。<br>
C1カバレッジと似ていますが、C1カバレッジは条件分岐の結果をすべて通ればOKですが、C2カバレッジではすべての条件の結果を通る必要があります。<br>
今回のケースだと、「冬か?」と「最低気温が5度以下か?」という2つの条件のそれぞれに対してTrue/Falseの組み合わせを試す必要があります。</p>
<p>そのため、④の条件分岐を2つに分割し、以下のパターンのテストが必要になります。</p>
<table>
<thead>
<tr>
<th align="left">パターン</th>
<th align="center">②</th>
<th align="center">④-1</th>
<th align="center">④-2</th>
<th align="left">具体例</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">パターン1</td>
<td align="center">True</td>
<td align="center">True</td>
<td align="center">True</td>
<td align="left">降水確率が20%、季節は冬、最低気温2度。</td>
</tr>
<tr>
<td align="left">パターン2</td>
<td align="center">True</td>
<td align="center">True</td>
<td align="center">False</td>
<td align="left">降水確率が20%、季節は冬、最低気温12度。</td>
</tr>
<tr>
<td align="left">パターン3</td>
<td align="center">True</td>
<td align="center">False</td>
<td align="center">True</td>
<td align="left">降水確率が20%、季節は春、最低気温2度。</td>
</tr>
<tr>
<td align="left">パターン4</td>
<td align="center">True</td>
<td align="center">False</td>
<td align="center">False</td>
<td align="left">降水確率が20%、季節は春、最低気温12度。</td>
</tr>
<tr>
<td align="left">パターン5</td>
<td align="center">False</td>
<td align="center">True</td>
<td align="center">True</td>
<td align="left">降水確率が50%、季節は冬、最低気温2度。</td>
</tr>
<tr>
<td align="left">パターン6</td>
<td align="center">False</td>
<td align="center">True</td>
<td align="center">False</td>
<td align="left">降水確率が50%、季節は冬、最低気温12度。</td>
</tr>
<tr>
<td align="left">パターン7</td>
<td align="center">False</td>
<td align="center">False</td>
<td align="center">False</td>
<td align="left">降水確率が50%、季節は春、最低気温2度。</td>
</tr>
<tr>
<td align="left">パターン8</td>
<td align="center">False</td>
<td align="center">False</td>
<td align="center">True</td>
<td align="left">降水確率が50%、季節は春、最低気温12度。</td>
</tr>
</tbody>
</table>
<p>具体的には以下のパラメータでテストをやればOKです。</p>
<h2 id="テストコード">テストコード</h2>
<p>それぞれのカバレッジでのパターンも把握したので、さっそくテストコードを書いていきます。<br>
Golangには標準でテスト用のパッケージが用意されているのでそれを使います。</p>
<p>C0カバレッジ100%のコードは以下の通りです。<br>
単純にテスト対象の関数を呼び出して、想定通りの結果が返ってくるか、を見ています。<br>
<script type="application/javascript" src="https://gist.github.com/foresukecom/065709efaf129cfad317f8daaeaa92c9.js"></script>
</p>
<p>C1カバレッジ100%のコードは以下の通りです。<br>
テストパターンが増えたので、テストの入力、想定される出力、実際の出力をまとめた構造体の配列を用意して、繰り返し処理をしています。<br>
<script type="application/javascript" src="https://gist.github.com/foresukecom/58d22dcfe10f45d1d24b4d2224f143e9.js"></script>
</p>
<p>C2カバレッジ100%のコードは以下の通りです。<br>
こちらはC1カバレッジと同じ構造ですね。パターンだけ増やしました。
<script type="application/javascript" src="https://gist.github.com/foresukecom/fdee2f025b6c7353511d1ed06c25bf5c.js"></script>
</p>
<h2 id="カバレッジ">カバレッジ</h2>
<p><code>go test</code>では <code>-cover</code>オプションでカバレッジを確認することもできます。</p>
<pre><code>$ go test -cover -run  TestEquipmentC0
PASS
coverage: 100.0% of statements
ok      github.com/foresukecom/go_test  0.005s

$ go test -cover -run  TestEquipmentC1
PASS
coverage: 100.0% of statements
ok      github.com/foresukecom/go_test  0.005s

$ go test -cover -run  TestEquipmentC2
PASS
coverage: 100.0% of statements
ok      github.com/foresukecom/go_test  0.005s
</code></pre><p>各テストコードを確認したところ、全コードでカバレッジが100%になりました。C0のカバレッジが確認できるようです。<br>
C1、C2カバレッジも確認できるといいんですが、オプションとかを見た感じだとなさそうです…<br>
なにかC1、C2カバレッジが確認しやすいツールがあれば教えてください。</p>
<h2 id="その他">その他</h2>
<p>Life is Strange: Before the Stormをクリアしました。<br>
Life is Strangeの前日譚ということで、結末はある程度わかっていたので余計に辛いものがありました。
前作と同様に、プレイヤーに大きな選択を強いてくるのですが、プレッシャーに耐えきれず、腕立て伏せをして気を落ち着かせてから改めてプレイしたことはいい思い出です。<br>
クロエ、マックス、レイチェル…みな尊い😇</p>
<p>前作に引続き音楽もよかったので、在宅中はよくスマートスピーカーで再生し続けています。</p>
<div class="embed steam-link">
    <iframe class="steam-link" src="https://store.steampowered.com/widget/554620/" frameborder="0" width="646" height="190"></iframe>
</div>


      
      
      
    </article>
    
 <aside><div id="disqus_thread"></div></aside>

<script type="text/javascript">
     
    var disqus_shortname = 'foresuke-com';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



  </main>
  
  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="http://foresukecom.github.io/post/goodby_chromebook/" rel="prev">ChromebookにUbuntuをインストールしようとした愚か者のお話</a></span>
    
    
      <span class="next"><a href="http://foresukecom.github.io/post/resign/" rel="next">退職エントリ</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="/images/profile.JPG" width="64" height="64"><br>
      
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-89386946-1', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>

